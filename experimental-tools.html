<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Solar Farm Collector Designer</title>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet"/>
  <style>
    body { font-family:'Inter',sans-serif; background:#f0f8ff; margin:0 }
    main { padding:20px; max-width:1800px; margin:auto }
    label { display:block; margin:10px 0 4px; font-weight:600 }
    input, textarea {
      width:300px; padding:8px; margin-bottom:10px;
      border:1px solid #ccc; border-radius:6px;
    }
    button {
      margin:10px 10px 0 0; padding:10px 16px;
      background:#0a66c2; color:#fff; border:none;
      border-radius:6px; cursor:pointer;
    }
    button:hover { background:#004a99 }
    #canvasContainer {
      width:100%; height:70vh; min-height:500px;
      border:1px solid #ccc; overflow:hidden;
      position:relative; cursor:grab;
    }
    #canvasContainer.grabbing { cursor:grabbing }
    canvas { transform-origin:0 0; display:block }
    #coordContainer { display:grid; grid-template-columns:1fr 1fr 1fr 1fr; gap:10px; margin-top:10px }
    .coordPane {
      background:#fff; border:1px solid #ccc;
      padding:10px; font-family:monospace; white-space:pre;
      max-height:300px; overflow:auto;
    }
  </style>
</head>
<body>
<main>
  <h1>âš¡ Solar Farm Collector Designer</h1>
  <label>Total Inverters</label>
  <input type="number" id="total" placeholder="e.g., 40">
  <label>Default Inverters per Feeder</label>
  <input type="number" id="perFeeder" placeholder="e.g., 8">
  <label>Custom Feeder Configuration</label>
  <textarea id="customFeeder" placeholder="e.g., 4,4,4,4"></textarea>
  <label>Capacitor Bank (kVAR)</label>
  <input type="number" id="capacitor" placeholder="e.g., 500">
  <label>MV Voltage (kV)</label>
  <input type="number" id="mvVoltage" value="34.5" step="0.1">
  <label>LV Voltage (kV)</label>
  <input type="number" id="lvVoltage" value="0.66" step="0.01">
  <label>Impedance (Z pu)</label>
  <input type="number" id="impedance" placeholder="e.g., 0.03" step="0.01"/>
  <div><input type="checkbox" id="lvLoad"><label for="lvLoad">Add Load on LV side</label></div>
  <div><input type="checkbox" id="showLegend" checked><label for="showLegend">Show Legend</label></div>
  <div><input type="checkbox" id="showCoords"><label for="showCoords">Show Bus Coordinates</label></div>
  <button id="genBtn">Generate</button>
  <button id="resetBtn">Reset View</button>
  <button id="zoomInBtn">Zoom In</button>
  <button id="zoomOutBtn">Zoom Out</button>
  <label for="zoomSlider">Zoom:</label>
  <input type="range" id="zoomSlider" min="0.1" max="10" step="0.1" value="1">
  <button id="exportSvgBtn">Export SVG</button>
  <button id="exportPdfBtn">Export PDF</button>
  <button id="downloadLocBtn">Download .loc</button>
  <button id="downloadIdvBtn">bus.idv</button>
  <button id="downloadBranchIdvBtn">branch.idv</button>
  <div id="canvasContainer">
    <canvas id="schematicCanvas" width="1800" height="2400"></canvas>
  </div>
  <div id="coordContainer">
    <div id="leftPane" class="coordPane">Bus coords appear here.</div>
    <div id="locPane"  class="coordPane">.loc output appears here.</div>
    <div id="idvPane"  class="coordPane">.idv output appears here.</div>
    <div id="branchIdvPane" class="coordPane">branch.idv output appears here.</div>
  </div>
</main>
<script>
document.addEventListener('DOMContentLoaded', () => {
  let parsedLayout = [], poiOrigin={x:0,y:0}, busCoords=[], branches=[];
  let mvKV = 34.5, lvKV = 0.66;

  // ...rest of your initialization and pan/zoom code unchanged...

  const container      = document.getElementById('canvasContainer'),
        canvas         = document.getElementById('schematicCanvas'),
        ctx            = canvas.getContext('2d'),
        slider         = document.getElementById('zoomSlider'),
        genBtn         = document.getElementById('genBtn'),
        resetBtn       = document.getElementById('resetBtn'),
        zoomInBtn      = document.getElementById('zoomInBtn'),
        zoomOutBtn     = document.getElementById('zoomOutBtn'),
        exportSvgBtn   = document.getElementById('exportSvgBtn'),
        exportPdfBtn   = document.getElementById('exportPdfBtn'),
        downloadLocBtn = document.getElementById('downloadLocBtn'),
        downloadIdvBtn = document.getElementById('downloadIdvBtn'),
        downloadBranchIdvBtn = document.getElementById('downloadBranchIdvBtn'),
        showCoordsChk  = document.getElementById('showCoords'),
        leftPane       = document.getElementById('leftPane'),
        locPane        = document.getElementById('locPane'),
        idvPane        = document.getElementById('idvPane'),
        branchIdvPane  = document.getElementById('branchIdvPane');

  let scale=1, panX=0, panY=0, isPanning=false, startX=0, startY=0;

  // ...all your pan/zoom, drawLayout, and bus/branch/cable logic, unchanged...

  function updatePanes(){
    // ...existing code up to idvPane.textContent = idv;
    idvPane.textContent = idv;
    // ADD THIS for branch.idv:
    const branchOnly = idv.split('\n')
      .filter(line => line.startsWith('BAT_BRANCH_DATA_3') || line.startsWith('BAT_BRANCH_CHNG_3') || line.startsWith('BAT_NEWSEQ') || line.startsWith('BAT_SEQ_BRANCH_DATA_3'))
      .join('\n');
    branchIdvPane.textContent = branchOnly;
  }

  // ADD THIS for branch.idv download:
  downloadBranchIdvBtn.addEventListener('click',()=>{
    const txt = branchIdvPane.textContent;
    if(!txt)return alert('Generate first');
    const blob=new Blob([txt],{type:'text/plain'}),a=document.createElement('a');
    a.href=URL.createObjectURL(blob);a.download='branch.idv';a.click();URL.revokeObjectURL(a.href);
  });

  // ...rest of your handlers and logic, unchanged...
});
</script>
</body>
</html>
