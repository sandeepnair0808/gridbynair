<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Solar Farm Collector Designer</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link 
    href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" 
    rel="stylesheet"
  >
  <style>
    body { font-family:'Inter',sans-serif; background:#f0f8ff; margin:0 }
    main { padding:20px; max-width:1800px; margin:auto }
    label { display:block; margin:10px 0 4px; font-weight:600 }
    input, textarea {
      width:300px; padding:8px; margin-bottom:10px;
      border:1px solid #ccc; border-radius:6px;
    }
    button {
      margin:10px 10px 0 0; padding:10px 16px;
      background:#0a66c2; color:#fff; border:none;
      border-radius:6px; cursor:pointer;
    }
    button:hover { background:#004a99 }
    #canvasContainer {
      width:100%; height:80vh; min-height:600px;
      border:1px solid #ccc; overflow:hidden; position:relative; cursor:grab;
    }
    #canvasContainer.grabbing { cursor:grabbing }
    canvas { transform-origin:0 0; display:block }
    #coordContainer { display:flex; gap:10px; margin-top:10px }
    .coordPane {
      flex:1; background:#fff; border:1px solid #ccc;
      padding:10px; font-family:monospace; white-space:pre;
      max-height:300px; overflow:auto;
    }
  </style>
</head>
<body>
<main>
  <h1>⚡ Solar Farm Collector Designer</h1>

  <label>Total Inverters</label>
  <input type="number" id="total" placeholder="e.g., 40">

  <label>Default Inverters per Feeder</label>
  <input type="number" id="perFeeder" placeholder="e.g., 8">

  <label>Custom Feeder Configuration</label>
  <textarea id="customFeeder" placeholder="e.g., 4,4,4,4"></textarea>

  <label>Capacitor Bank (kVAR)</label>
  <input type="number" id="capacitor" placeholder="e.g., 500">

  <label>Voltage (kV)</label>
  <input type="number" id="voltage" placeholder="e.g., 33">

  <label>Impedance (Z pu)</label>
  <input type="number" id="impedance" placeholder="e.g., 0.03" step="0.01">

  <div><input type="checkbox" id="lvLoad"><label for="lvLoad">Add Load on LV side</label></div>
  <div><input type="checkbox" id="showLegend" checked><label for="showLegend">Show Legend</label></div>
  <div><input type="checkbox" id="showCoords"><label for="showCoords">Show Bus Coordinates</label></div>

  <button id="genBtn">Generate</button>
  <button id="resetBtn">Reset View</button>
  <button id="zoomInBtn">Zoom In</button>
  <button id="zoomOutBtn">Zoom Out</button>
  <label for="zoomSlider">Zoom:</label>
  <input type="range" id="zoomSlider" min="0.1" max="10" step="0.1" value="1">
  <button id="exportSvgBtn">Export SVG</button>
  <button id="exportPdfBtn">Export PDF</button>
  <button id="downloadLocBtn">Download .loc</button>

  <div id="canvasContainer">
    <canvas id="schematicCanvas" width="1800" height="2400"></canvas>
  </div>

  <div id="coordContainer">
    <div id="leftPane" class="coordPane">
      Bus coordinates will appear here when you check “Show Bus Coordinates” and hit Generate.
    </div>
    <div id="rightPane" class="coordPane">
      <!-- Future right‐pane content -->
      <strong>Right Pane</strong>
      <p>Reserved for additional information.</p>
    </div>
  </div>
</main>

<script>
document.addEventListener('DOMContentLoaded', () => {
  let parsedLayout = [], poiOrigin = {x:0,y:0}, busCoords = [];

  const
    container      = document.getElementById('canvasContainer'),
    canvas         = document.getElementById('schematicCanvas'),
    ctx            = canvas.getContext('2d'),
    slider         = document.getElementById('zoomSlider'),
    genBtn         = document.getElementById('genBtn'),
    resetBtn       = document.getElementById('resetBtn'),
    zoomInBtn      = document.getElementById('zoomInBtn'),
    zoomOutBtn     = document.getElementById('zoomOutBtn'),
    exportSvgBtn   = document.getElementById('exportSvgBtn'),
    exportPdfBtn   = document.getElementById('exportPdfBtn'),
    downloadLocBtn = document.getElementById('downloadLocBtn'),
    leftPane       = document.getElementById('leftPane');

  let scale=1, panX=0, panY=0, isPanning=false, startX=0, startY=0;

  function updateTransform(){
    canvas.style.transform = `translate(${panX}px,${panY}px) scale(${scale})`;
  }
  function resetView(){
    scale=1; panX=0; panY=0;
    updateTransform(); slider.value=scale;
  }
  function zoomTo(ns,cx=canvas.clientWidth/2,cy=canvas.clientHeight/2){
    panX -= (cx/scale - cx/ns);
    panY -= (cy/scale - cy/ns);
    scale=ns; updateTransform(); slider.value=ns;
  }

  slider.addEventListener('input', e=>zoomTo(+e.target.value));
  zoomInBtn.addEventListener('click', ()=>zoomTo(Math.min(scale*1.1,10)));
  zoomOutBtn.addEventListener('click', ()=>zoomTo(Math.max(scale*0.9,0.1)));
  resetBtn.addEventListener('click', resetView);

  container.addEventListener('wheel', e=>{
    e.preventDefault();
    const d=-e.deltaY*0.001,
          ns=Math.min(Math.max(scale+d,0.1),10),
          r=canvas.getBoundingClientRect();
    zoomTo(ns,e.clientX-r.left,e.clientY-r.top);
  });
  container.addEventListener('mousedown', e=>{
    isPanning=true; container.classList.add('grabbing');
    startX=e.clientX-panX; startY=e.clientY-panY;
  });
  document.addEventListener('mousemove', e=>{
    if (!isPanning) return;
    panX=e.clientX-startX; panY=e.clientY-startY;
    updateTransform();
  });
  document.addEventListener('mouseup', ()=>{ isPanning=false; container.classList.remove('grabbing'); });

  genBtn.addEventListener('click', generateCollector);
  exportSvgBtn.addEventListener('click', exportSVG);
  exportPdfBtn.addEventListener('click', exportPNGasPDF);
  downloadLocBtn.addEventListener('click', downloadLOC);

  function generateCollector(){
    const total    = +document.getElementById('total').value;
    if (!total) return alert('Enter total inverters');
    const perFeeder= +document.getElementById('perFeeder').value,
          custom   = document.getElementById('customFeeder').value.trim(),
          capacitor= +document.getElementById('capacitor').value,
          voltage  = +document.getElementById('voltage').value,
          impedance= +document.getElementById('impedance').value,
          lvLoad   = document.getElementById('lvLoad').checked;

    let feederConfig=[], rem=total;
    if (custom){
      feederConfig=custom.split(',').map(n=>+n).filter(n=>n>0);
      let sum=feederConfig.reduce((a,b)=>a+b,0);
      if(sum<total) while(sum++<total) feederConfig.push(1);
      else if(sum>total){
        let run=0;
        feederConfig=feederConfig.filter(n=>{
          if(run+n<=total){run+=n;return true;}
          if(run<total){feederConfig.push(total-run);run=total;return true;}
          return false;
        });
      }
    } else {
      while(rem>0){
        const cnt=Math.min(perFeeder||total,rem);
        feederConfig.push(cnt); rem-=cnt;
      }
    }

    parsedLayout=[];
    feederConfig.forEach((cnt,i)=>{
      for(let j=0;j<cnt;j++){
        parsedLayout.push({
          feeder:i+1,
          inverter:parsedLayout.length+1,
          capacitor,voltage,impedance,hasLoad:lvLoad
        });
      }
    });

    drawLayout(feederConfig);
    fitToContainer();
  }

  function drawLayout(feederConfig){
    ctx.setTransform(1,0,0,1,0,0);
    ctx.clearRect(0,0,canvas.width,canvas.height);
    updateTransform();
    busCoords=[];

    const startX=100, poiY=100, gsuY=poiY+80, mvY=gsuY+80,
          sx=180, sy=100, bLen=50, poiLen=200,
          midX=startX+feederConfig.length*sx/2,
          poiStart=midX-poiLen/2, poiEnd=midX+poiLen/2;
    poiOrigin={x:midX,y:poiY};

    const line=(x1,y1,x2,y2,c,w=2)=>{
      ctx.save(); ctx.strokeStyle=c; ctx.lineWidth=w;
      ctx.beginPath(); ctx.moveTo(x1,y1); ctx.lineTo(x2,y2); ctx.stroke(); ctx.restore();
    };

    // 1) POI BUS
    line(poiStart,poiY,poiEnd,poiY,'#000',3);
    ctx.save(); ctx.fillStyle='#000'; ctx.font='12px Inter';
      ctx.fillText('POI BUS', poiStart, poiY-10);
    ctx.restore();
    busCoords.push({ name:'POI BUS', x:poiStart-poiOrigin.x+poiLen/2, y:0, padWidth:poiLen/2, padHeight:0 });

    // 2) Generator & T-Line
    ctx.save(); ctx.beginPath(); ctx.arc(midX,poiY-30,10,0,2*Math.PI); ctx.stroke();
      ctx.fillText('Generator',midX-30,poiY-45);
    ctx.restore();
    line(midX,poiY-20,midX,poiY,'#000');
    line(midX,poiY,midX,gsuY,'#000');
    ctx.save(); ctx.fillText('T-Line',midX+10,(poiY+gsuY)/2); ctx.restore();

    // 3) GSU HV BUS
    line(poiStart,gsuY,poiEnd,gsuY,'#0a66c2',4);
    ctx.save(); ctx.fillText('GSU HV BUS',poiStart,gsuY-10); ctx.restore();
    busCoords.push({ name:'GSU HV BUS', x:poiStart-poiOrigin.x+poiLen/2, y:gsuY-poiOrigin.y, padWidth:poiLen/2, padHeight:20 });

    // Transformer
    const xfH=40, xfT=(gsuY+mvY)/2-xfH/2;
    line(midX,gsuY,midX,xfT,'#2ecc71',2);
    ctx.save(); ctx.fillStyle='#2ecc71'; ctx.fillRect(midX-10,xfT,20,xfH); ctx.restore();
    line(midX,xfT+xfH,midX,mvY,'#2ecc71',2);

    // 4) SUB-MV BUS
    const subW=feederConfig.length*sx;
    line(startX,mvY,startX+subW,mvY,'#0a66c2',4);
    ctx.save(); ctx.fillText('SUB-MV BUS',startX,mvY-10); ctx.restore();
    busCoords.push({ name:'SUB-MV BUS', x:startX-poiOrigin.x+subW/2, y:mvY-poiOrigin.y, padWidth:subW/2, padHeight:0 });

    // 5) Feeders & Inverters
    let invC=0, fx=startX+40;
    feederConfig.forEach((cnt,fi)=>{
      const botY=mvY+cnt*sy;
      line(fx,mvY,fx,botY,'#444',2);

      for(let j=0;j<cnt;j++){
        const y=mvY+(j+1)*sy, nm=`INV${1001+invC}`;

        // MV node
        line(fx,y,fx+bLen,y,'#0a66c2',2);
        ctx.save(); ctx.fillStyle='red'; ctx.beginPath(); ctx.arc(fx,y,4,0,2*Math.PI); ctx.fill();
          ctx.fillText(nm,fx-55,y-10);
        ctx.restore();
        busCoords.push({ name:nm, x:fx-poiOrigin.x, y:y-poiOrigin.y, padWidth:bLen+12, padHeight:sy/2 });

        // padmount
        ctx.save(); ctx.fillStyle='#2ecc71'; ctx.fillRect(fx+bLen,y-10,20,20); ctx.restore();

        // LV node & box
        const tX=fx+bLen+10, tT=y+10, tB=y+40, tM=(tT+tB)/2;
        line(tX,tT,tX,tB,'#ff9900',2);
        ctx.save(); ctx.fillStyle='blue'; ctx.beginPath(); ctx.arc(tX,tM,4,0,2*Math.PI); ctx.fill();
          ctx.fillText(`${nm}_LV`,tX+10,tM+10);
        ctx.restore();
        busCoords.push({ name:`${nm}_LV`, x:tX-poiOrigin.x, y:tM-poiOrigin.y, padWidth:12, padHeight:12 });

        // inverter box
        ctx.save(); ctx.fillStyle='#ffcc00'; ctx.fillRect(fx+bLen-2,tB,24,24); ctx.restore();
        ctx.save(); ctx.fillStyle='#000'; ctx.fillText(`I${invC+1}`,fx+bLen-5,tB+35); ctx.restore();

        // optional load
        if(parsedLayout[invC].hasLoad){
          ctx.save(); ctx.fillStyle='#ff4444'; ctx.beginPath(); ctx.arc(tX+20,tB+12,5,0,2*Math.PI); ctx.fill(); ctx.restore();
        }

        invC++;
      }

      // feeder label
      const base=11+Math.floor(fi/2), suf=fi%2?'B':'A', flbl=`${base}${suf}`;
      ctx.save(); ctx.fillText(flbl,fx-10,botY+30); ctx.restore();
      // include in footprint
      const metrics=ctx.measureText(flbl);
      busCoords.push({ name:flbl, x:fx-poiOrigin.x, y:botY+30-poiOrigin.y, padWidth:metrics.width/2, padHeight:0 });

      fx+=sx;
    });

    // Legend
    if(document.getElementById('showLegend').checked){
      const LX=1400, LY=100;
      [['Red Dot','MV Bus Point'],['Green Box','Transformer'],['Blue Dot','LV Bus Point'],['Yellow Box','Inverter'],['Red Circle','LV Load']]
      .forEach(([sh,txt],i=>{
        const y=LY+20+i*20, clr=sh.includes('Red')?'red':sh.includes('Green')?'#2ecc71':sh.includes('Blue')?'blue':'#ffcc00';
        ctx.save(); ctx.fillStyle=clr;
          if(sh.includes('Dot')){ ctx.beginPath(); ctx.arc(LX+10,y-4,5,0,2*Math.PI); ctx.fill(); }
          else ctx.fillRect(LX+3,y-10,14,14);
        ctx.restore();
        ctx.save(); ctx.fillStyle='#000'; ctx.fillText(txt,LX+25,y); ctx.restore();
      }));
    }

    // Coordinates pane (filter out feeder labels)
    if(document.getElementById('showCoords').checked){
      const coordsOnly = busCoords.filter(b=>!/^\d+(?:A|B)$/.test(b.name));
      leftPane.textContent = coordsOnly
        .map(b=>`${b.name.padEnd(12)} (${b.x.toFixed(0).padStart(4)}, ${b.y.toFixed(0).padStart(4)})`)
        .join('\n');
    } else {
      leftPane.textContent='Bus coordinates will appear here…';
    }
  }

  function fitToContainer(margin=40){
    if(!busCoords.length) return;
    const allX=[], allY=[];
    busCoords.forEach(p=>{
      const ax=p.x+poiOrigin.x, ay=p.y+poiOrigin.y;
      allX.push(ax-p.padWidth,ax+p.padWidth);
      allY.push(ay-p.padHeight,ay+p.padHeight);
    });
    const minX=Math.min(...allX), maxX=Math.max(...allX),
          minY=Math.min(...allY), maxY=Math.max(...allY),
          contentW=(maxX-minX)+margin*2,
          contentH=(maxY-minY)+margin*2,
          CW=container.clientWidth, CH=container.clientHeight,
          scaleX=CW/contentW, scaleY=CH/contentH,
          offX=(CW-contentW*scaleX)/2-(minX-margin)*scaleX,
          offY=(CH-contentH*scaleY)/2-(minY-margin)*scaleY;
    canvas.style.transform=`translate(${offX}px,${offY}px) scale(${scaleX},${scaleY})`;
    scale=Math.min(scaleX,scaleY);
    slider.value=scale;
    panX=offX; panY=offY;
  }

  function exportSVG(){
    const a=document.createElement('a');
    a.download='schematic.svg';
    a.href=canvas.toDataURL('image/svg+xml');
    a.click();
  }
  function exportPNGasPDF(){
    const img=canvas.toDataURL('image/png'), w=window.open();
    w.document.write(`<img src="${img}" style="width:100%">`);
  }

  function downloadLOC(){
    if(!busCoords.length) return alert('Generate diagram first');
    const coords=busCoords.filter(b=>!/^\d+(?:A|B)$/.test(b.name));
    let text='GEOPHYSICAL\n';
    coords.forEach(b=>{
      const digits=(b.name.match(/\d+/)||[''])[0];
      let busNum;
      if(b.name.endsWith('_LV')){
        busNum=digits[0]+'0'+digits.slice(1);
      } else busNum=digits;
      const lon=Math.abs(b.x).toFixed(6)+(b.x<0?'W':'E'),
            lat=Math.abs(b.y).toFixed(6)+(b.y<0?'S':'N');
      text+=`${busNum}  ${lon}  ${lat}  90  0.80\n`;
    });
    text+='BRANCHES\n';
    const blob=new Blob([text],{type:'text/plain'}), a=document.createElement('a');
    a.href=URL.createObjectURL(blob);
    a.download='buses.loc';
    a.click();
    URL.revokeObjectURL(a.href);
  }

  window.addEventListener('resize', fitToContainer);
  if('ResizeObserver' in window) new ResizeObserver(fitToContainer).observe(container);
});
</script>
</body>
</html>
