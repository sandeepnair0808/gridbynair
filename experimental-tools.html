<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Solar Farm Collector Designer</title>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet"/>
  <style>
    body { font-family:'Inter',sans-serif; background:#f0f8ff; margin:0 }
    main { padding:20px; max-width:1800px; margin:auto }
    label { display:block; margin:10px 0 4px; font-weight:600 }
    input, textarea {
      width:300px; padding:8px; margin-bottom:10px;
      border:1px solid #ccc; border-radius:6px;
    }
    button {
      margin:10px 10px 0 0; padding:10px 16px;
      background:#0a66c2; color:#fff; border:none;
      border-radius:6px; cursor:pointer;
    }
    button:hover { background:#004a99 }
    #canvasContainer {
      width:100%; height:65vh; min-height:500px;
      border:1px solid #ccc; overflow:hidden;
      position:relative; cursor:grab; background:#fafdff;
    }
    #canvasContainer.grabbing { cursor:grabbing }
    canvas { transform-origin:0 0; display:block }
    #coordContainer { display:grid; grid-template-columns:1fr 1fr 1fr 1fr; gap:10px; margin-top:10px }
    .coordPane {
      background:#fff; border:1px solid #ccc;
      padding:10px; font-family:monospace; white-space:pre;
      max-height:300px; overflow:auto; font-size:13px;
    }
  </style>
</head>
<body>
<main>
  <h1>âš¡ Solar Farm Collector Designer</h1>
  <label>Total Inverters</label><input type="number" id="total" placeholder="e.g., 40">
  <label>Default Inverters per Feeder</label><input type="number" id="perFeeder" placeholder="e.g., 8">
  <label>Custom Feeder Configuration</label><textarea id="customFeeder" placeholder="e.g., 4,4,4,4"></textarea>
  <label>Capacitor Bank (kVAR)</label><input type="number" id="capacitor" placeholder="e.g., 500">
  <label>MV Voltage (kV)</label><input type="number" id="mvVoltage" value="34.5" step="0.1">
  <label>LV Voltage (kV)</label><input type="number" id="lvVoltage" value="0.66" step="0.01">
  <label>Impedance (Z pu)</label><input type="number" id="impedance" placeholder="e.g., 0.03" step="0.01"/>
  <div><input type="checkbox" id="lvLoad"><label for="lvLoad">Add Load on LV side</label></div>
  <div><input type="checkbox" id="showLegend" checked><label for="showLegend">Show Legend</label></div>
  <div><input type="checkbox" id="showCoords"><label for="showCoords">Show Bus Coordinates</label></div>

  <button id="genBtn">Generate</button>
  <button id="resetBtn">Reset View</button>
  <button id="zoomInBtn">Zoom In</button>
  <button id="zoomOutBtn">Zoom Out</button>
  <label for="zoomSlider">Zoom:</label><input type="range" id="zoomSlider" min="0.1" max="3" step="0.01" value="1">

  <button id="downloadLocBtn">Download .loc</button>
  <button id="downloadIdvBtn">bus.idv</button>
  <button id="downloadBranchIdvBtn">branch.idv</button>

  <div id="canvasContainer"><canvas id="schematicCanvas" width="1800" height="2000"></canvas></div>
  <div id="coordContainer">
    <div id="leftPane" class="coordPane">Bus coords appear here.</div>
    <div id="locPane"  class="coordPane">.loc output appears here.</div>
    <div id="idvPane"  class="coordPane">bus.idv output appears here.</div>
    <div id="branchIdvPane" class="coordPane">branch.idv output appears here.</div>
  </div>
</main>
<script>
// State
let parsedLayout=[], busCoords=[], branches=[];
let mvKV=34.5, lvKV=0.66;
const canvas=document.getElementById('schematicCanvas'), ctx=canvas.getContext('2d');
const container=document.getElementById('canvasContainer');
let scale=1, panX=0, panY=0, isPanning=false, startX=0, startY=0;

// Pan/Zoom...
document.getElementById('zoomSlider').addEventListener('input',e=>zoomTo(+e.target.value));
['resetBtn','zoomInBtn','zoomOutBtn','canvasContainer'].forEach(id=>{});
// ... (same as previous)

function generateCollector(){
  // build feederConfig & parsedLayout (same as before)
  drawLayout(feederConfig);
  fitToContainer(); updatePanes();
}

document.getElementById('genBtn').onclick=generateCollector;

function drawLayout(feederConfig){
  ctx.setTransform(1,0,0,1,0,0);ctx.clearRect(0,0,canvas.width,canvas.height);
  busCoords=[]; branches=[];
  const cx=900, POI_Y=100, GSU_Y=180, XFMR_Y=230, SUBMV_Y=340;
  const sx=180, sy=100, nF=feederConfig.length;
  // draw generator, POI, T-line, GSU bus, transformer, SUBMV bus (same)

  // Place MV inverter points
  let invIdx=0, globalMVs=[];
  feederConfig.forEach((cnt,fi)=>{
    const x=cx-((nF-1)/2)*sx + fi*sx;
    for(let j=0;j<cnt;j++){
      const y=SUBMV_Y+40+j*sy;
      globalMVs.push({x,y,name:`INV${1001+invIdx}`});
      invIdx++;
    }
  });
  // Draw split cables globally
  ctx.save();ctx.strokeStyle='#aaa';ctx.lineWidth=3;
  // submv to first inv
  if(globalMVs.length){ ctx.beginPath();ctx.moveTo(cx,SUBMV_Y);ctx.lineTo(globalMVs[0].x,globalMVs[0].y);ctx.stroke(); }
  // inv to next inv
  for(let i=0;i<globalMVs.length-1;i++){
    const a=globalMVs[i], b=globalMVs[i+1];
    ctx.beginPath();ctx.moveTo(a.x,a.y);ctx.lineTo(b.x,b.y);ctx.stroke();
  }
  ctx.restore();

  // Then draw each MV jog, padmount, LV jog
  globalMVs.forEach(pt=>{
    // MV segment
    ctx.save();ctx.strokeStyle='red';ctx.lineWidth=4;ctx.beginPath();ctx.moveTo(pt.x-15,pt.y);ctx.lineTo(pt.x+15,pt.y);ctx.stroke();ctx.fillStyle='#000';ctx.font='12px Inter';ctx.fillText(pt.name,pt.x+18,pt.y+4);ctx.restore();
    busCoords.push({name:pt.name,x:pt.x,y:pt.y});
    
    // padmount offset to right
    const xPAD = pt.x + 20;
    const yPAD = pt.y + 32;
    ctx.save();ctx.fillStyle='#2ecc71';ctx.fillRect(xPAD-8,yPAD-8,16,16);ctx.restore();
    busCoords.push({name:pt.name+'_PAD',x:xPAD,y:yPAD});

    // LV segment offset further right
    const xLV = pt.x + 40;
    const lvY = yPAD + 32;
    const lvName = `${pt.name}_LV`;
    ctx.save();ctx.strokeStyle='blue';ctx.lineWidth=4;
      ctx.beginPath();ctx.moveTo(xLV-15,lvY);ctx.lineTo(xLV+15,lvY);ctx.stroke();
      ctx.fillStyle='#000';ctx.font='12px Inter';ctx.fillText(lvName,xLV+18,lvY+4);
    ctx.restore();
    busCoords.push({name:lvName,x:xLV,y:lvY});
  });
