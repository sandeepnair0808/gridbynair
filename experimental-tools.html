<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Solar Farm Collector Designer</title>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet"/>
  <style>
    body { font-family:'Inter',sans-serif; background:#f0f8ff; margin:0 }
    main { padding:20px; max-width:1800px; margin:auto }
    label { display:block; margin:10px 0 4px; font-weight:600 }
    input, textarea {
      width:300px; padding:8px; margin-bottom:10px;
      border:1px solid #ccc; border-radius:6px;
    }
    button {
      margin:10px 10px 0 0; padding:10px 16px;
      background:#0a66c2; color:#fff; border:none;
      border-radius:6px; cursor:pointer;
    }
    button:hover { background:#004a99 }
    #canvasContainer {
      width:100%; height:65vh; min-height:400px;
      border:1px solid #ccc; overflow:hidden;
      position:relative; cursor:grab;
      background: #fafdff;
    }
    #canvasContainer.grabbing { cursor:grabbing }
    canvas { transform-origin:0 0; display:block }
    #coordContainer { display:grid; grid-template-columns:1fr 1fr 1fr 1fr; gap:10px; margin-top:10px }
    .coordPane {
      background:#fff; border:1px solid #ccc;
      padding:10px; font-family:monospace; white-space:pre;
      max-height:300px; overflow:auto;
      font-size:13px;
    }
  </style>
</head>
<body>
<main>
  <h1>âš¡ Solar Farm Collector Designer</h1>
  <label>Total Inverters</label>
  <input type="number" id="total" placeholder="e.g., 40">
  <label>Default Inverters per Feeder</label>
  <input type="number" id="perFeeder" placeholder="e.g., 8">
  <label>Custom Feeder Configuration</label>
  <textarea id="customFeeder" placeholder="e.g., 4,4,4,4"></textarea>
  <label>Capacitor Bank (kVAR)</label>
  <input type="number" id="capacitor" placeholder="e.g., 500">
  <label>MV Voltage (kV)</label>
  <input type="number" id="mvVoltage" value="34.5" step="0.1">
  <label>LV Voltage (kV)</label>
  <input type="number" id="lvVoltage" value="0.66" step="0.01">
  <label>Impedance (Z pu)</label>
  <input type="number" id="impedance" placeholder="e.g., 0.03" step="0.01"/>
  <div><input type="checkbox" id="lvLoad"><label for="lvLoad">Add Load on LV side</label></div>
  <div><input type="checkbox" id="showLegend" checked><label for="showLegend">Show Legend</label></div>
  <div><input type="checkbox" id="showCoords"><label for="showCoords">Show Bus Coordinates</label></div>
  <button id="genBtn">Generate</button>
  <button id="resetBtn">Reset View</button>
  <button id="zoomInBtn">Zoom In</button>
  <button id="zoomOutBtn">Zoom Out</button>
  <label for="zoomSlider">Zoom:</label>
  <input type="range" id="zoomSlider" min="0.1" max="3" step="0.01" value="1">
  <button id="downloadLocBtn">Download .loc</button>
  <button id="downloadIdvBtn">bus.idv</button>
  <button id="downloadBranchIdvBtn">branch.idv</button>
  <div id="canvasContainer">
    <canvas id="schematicCanvas" width="1800" height="2000"></canvas>
  </div>
  <div id="coordContainer">
    <div id="leftPane" class="coordPane">Bus coords appear here.</div>
    <div id="locPane"  class="coordPane">.loc output appears here.</div>
    <div id="idvPane"  class="coordPane">bus.idv output appears here.</div>
    <div id="branchIdvPane" class="coordPane">branch.idv output appears here.</div>
  </div>
</main>
<script>
let parsedLayout=[], busCoords=[], branches=[];
let mvKV=34.5, lvKV=0.66;
const container=document.getElementById('canvasContainer'),
      canvas=document.getElementById('schematicCanvas'),
      ctx=canvas.getContext('2d');
let scale=1, panX=0, panY=0, isPanning=false, startX=0, startY=0;

// Pan & Zoom
function updateTransform(){ canvas.style.transform = `translate(${panX}px,${panY}px) scale(${scale})`; }
function resetView(){ scale = 1; panX = 0; panY = 0; updateTransform(); document.getElementById('zoomSlider').value = scale; }
function zoomTo(ns, cx = canvas.clientWidth/2, cy = canvas.clientHeight/2){ panX -= (cx/scale - cx/ns); panY -= (cy/scale - cy/ns); scale = ns; updateTransform(); document.getElementById('zoomSlider').value = ns; }
document.getElementById('zoomSlider').addEventListener('input', e => zoomTo(+e.target.value));
document.getElementById('resetBtn').addEventListener('click', resetView);
document.getElementById('zoomInBtn').addEventListener('click', () => zoomTo(Math.min(scale * 1.1, 3)));
document.getElementById('zoomOutBtn').addEventListener('click', () => zoomTo(Math.max(scale * 0.9, 0.1)));
container.addEventListener('wheel', e => { e.preventDefault(); const d = -e.deltaY * 0.001; const ns = Math.min(Math.max(scale + d, 0.1), 3); const r = canvas.getBoundingClientRect(); zoomTo(ns, e.clientX - r.left, e.clientY - r.top); });
container.addEventListener('mousedown', e => { isPanning = true; container.classList.add('grabbing'); startX = e.clientX - panX; startY = e.clientY - panY; });
document.addEventListener('mousemove', e => { if(!isPanning) return; panX = e.clientX - startX; panY = e.clientY - startY; updateTransform(); });
document.addEventListener('mouseup', () => { isPanning = false; container.classList.remove('grabbing'); });

// Generate & Draw
function generateCollector(){
  const total = +document.getElementById('total').value;
  if(!total) return alert('Enter total inverters');
  const perFeeder = +document.getElementById('perFeeder').value;
  const custom = document.getElementById('customFeeder').value.trim();
  mvKV = +document.getElementById('mvVoltage').value;
  lvKV = +document.getElementById('lvVoltage').value;
  let feederConfig = [], rem = total;
  if(custom){
    feederConfig = custom.split(',').map(n=>+n).filter(n=>n>0);
    let sum = feederConfig.reduce((a,b)=>a+b,0);
    if(sum < total) while(sum++ < total) feederConfig.push(1);
    else if(sum > total){ let run=0; feederConfig = feederConfig.filter(n=>{ if(run+n<=total){ run+=n; return true; } if(run<total){ feederConfig.push(total-run); run=total; return true;} return false; }); }
  } else {
    while(rem > 0){ const cnt = Math.min(perFeeder||total, rem); feederConfig.push(cnt); rem -= cnt; }
  }
  parsedLayout = [];
  feederConfig.forEach((cnt,i)=>{ for(let j=0;j<cnt;j++) parsedLayout.push({feeder: i+1}); });
  drawLayout(feederConfig);
  fitToContainer();
  updatePanes();
}
document.getElementById('genBtn').addEventListener('click', generateCollector);

function drawLayout(feederConfig){
  ctx.setTransform(1,0,0,1,0,0);
  ctx.clearRect(0,0,canvas.width,canvas.height);
  busCoords = [];

  const centerX = 900;
  const topY = 100;
  const sx = 180, sy=100;
  const nF = feederConfig.length;
  const POI_Y = topY, GSU_Y = POI_Y+80, XFMR_Y = GSU_Y+50, SUBMV_Y = GSU_Y+160;

  // Generator
  ctx.save();
    ctx.beginPath(); ctx.arc(centerX, POI_Y-35, 15,0,2*Math.PI); ctx.strokeStyle='#555'; ctx.lineWidth=2; ctx.stroke();
    ctx.beginPath(); ctx.moveTo(centerX, POI_Y-20); ctx.lineTo(centerX, POI_Y); ctx.stroke();
    ctx.font='bold 13px Inter'; ctx.fillStyle='#555'; ctx.fillText('GEN', centerX-20, POI_Y-45);
  ctx.restore();

  // POI Bus
  ctx.save(); ctx.strokeStyle='#0a66c2'; ctx.lineWidth=4;
    ctx.beginPath(); ctx.moveTo(centerX-50, POI_Y); ctx.lineTo(centerX+50, POI_Y); ctx.stroke();
    ctx.font='bold 13px Inter'; ctx.fillStyle='#0a66c2'; ctx.fillText('POI BUS', centerX+54, POI_Y+5);
  ctx.restore();
  busCoords.push({name:'POI BUS',x:centerX,y:POI_Y,padWidth:50,padHeight:0});

  // T-Line
  ctx.save(); ctx.strokeStyle='#000'; ctx.lineWidth=2;
    ctx.beginPath(); ctx.moveTo(centerX, POI_Y); ctx.lineTo(centerX, GSU_Y); ctx.stroke();
  ctx.restore();
  ctx.save(); ctx.font='12px Inter'; ctx.fillStyle='#333'; ctx.fillText('T-Line', centerX+8, (POI_Y+GSU_Y)/2); ctx.restore();

  // GSU HV Bus
  ctx.save(); ctx.strokeStyle='#0a66c2'; ctx.lineWidth=4;
    ctx.beginPath(); ctx.moveTo(centerX-50, GSU_Y); ctx.lineTo(centerX+50, GSU_Y); ctx.stroke();
    ctx.font='bold 13px Inter'; ctx.fillStyle='#0a66c2'; ctx.fillText('GSU HV BUS', centerX+54, GSU_Y+5);
  ctx.restore();
  busCoords.push({name:'GSU HV BUS',x:centerX,y:GSU_Y,padWidth:50,padHeight:0});

  // Transformer
  ctx.save(); ctx.strokeStyle='#2ecc71'; ctx.lineWidth=3;
    ctx.beginPath(); ctx.moveTo(centerX, GSU_Y); ctx.lineTo(centerX, XFMR_Y); ctx.stroke();
    ctx.fillStyle='#2ecc71'; ctx.fillRect(centerX-13, XFMR_Y, 26,44);
    ctx.font='12px Inter'; ctx.fillStyle='#000'; ctx.fillText('GSU XFMR', centerX+18, XFMR_Y+25);
  ctx.restore();

  // Transformer to SUB-MV
  ctx.save(); ctx.strokeStyle='#2ecc71'; ctx.lineWidth=3;
    ctx.beginPath(); ctx.moveTo(centerX, XFMR_Y+44); ctx.lineTo(centerX, SUBMV_Y); ctx.stroke();
  ctx.restore();

  // SUB-MV Bus
  const subW = (nF-1)*sx + 100;
  ctx.save(); ctx.strokeStyle='#0a66c2'; ctx.lineWidth=4;
    ctx.beginPath(); ctx.moveTo(centerX-subW/2, SUBMV_Y); ctx.lineTo(centerX+subW/2, SUBMV_Y); ctx.stroke();
    ctx.font='bold 13px Inter'; ctx.fillStyle='#0a66c2'; ctx.fillText('SUB-MV BUS', centerX+subW/2+10, SUBMV_Y+5);
  ctx.restore();
  busCoords.push({name:'SUB-MV BUS',x:centerX,y:SUBMV_Y,padWidth:subW/2,padHeight:0});

  // Feeders & Inverters
  let x0=centerX-((nF-1)/2)*sx;
  let invIdx=0;
  feederConfig.forEach((cnt,fI)=>{
    const x = x0 + fI*sx;
    ctx.save(); ctx.strokeStyle='#aaa'; ctx.lineWidth=3;
      ctx.beginPath(); ctx.moveTo(x, SUBMV_Y); ctx.lineTo(x, SUBMV_Y+40); ctx.stroke();
    ctx.restore();
    let prevY = SUBMV_Y+40;
    for(let j=0;j<cnt;j++){
      const yMV = prevY + sy;
      const yPAD = yMV + 32;
      const yLV = yPAD + 32;
      // vertical
      ctx.save(); ctx.strokeStyle='#aaa'; ctx.lineWidth=3;
        ctx.beginPath(); ctx.moveTo(x, prevY); ctx.lineTo(x, yMV); ctx.lineTo(x, yPAD); ctx.lineTo(x, yLV); ctx.stroke();
      ctx.restore();
      // MV
      const invName = `INV${1001 + invIdx}`;
      ctx.save(); ctx.beginPath(); ctx.arc(x, yMV, 8,0,2*Math.PI); ctx.fillStyle='red'; ctx.fill(); ctx.fillStyle='#000'; ctx.font='12px Inter'; ctx.fillText(invName, x+13, yMV+4); ctx.restore();
      busCoords.push({name:invName,x:x,y:yMV,padWidth:10,padHeight:0});
      // PAD
      ctx.save(); ctx.fillStyle='#2ecc71'; ctx.fillRect(x-8, yPAD-8,16,16); ctx.font='12px Inter'; ctx.fillStyle='#000'; ctx.fillText('PAD', x+13, yPAD+4); ctx.restore();
      // LV
      const lvName = invName + '_LV';
      ctx.save(); ctx.beginPath(); ctx.arc(x, yLV,6,0,2*Math.PI); ctx.fillStyle='blue'; ctx.fill(); ctx.fillStyle='#000'; ctx.fillText(lvName, x+11, yLV+4); ctx.restore();
      busCoords.push({name:lvName,x:x,y:yLV,padWidth:8,padHeight:0});
      prevY = yLV;
      invIdx++;
    }
  });
}

function updatePanes(){
  const coordsOnly = busCoords.filter(b=>!/^[0-9]+[AB]?$/.test(b.name));
  // Coordinates pane
  document.getElementById('leftPane').textContent = coordsOnly.map(b=>{
    const lon = Math.abs(b.x).toFixed(0).padStart(4)+(b.x<0?'W':'E');
    const lat = Math.abs(b.y).toFixed(0).padStart(4)+(b.y<0?'S':'N');
    return `${b.name.padEnd(12)} (${lon}, ${lat})`;
  }).join('\n');
  // .loc
  let locText = 'GEOPHYSICAL\n';
  coordsOnly.forEach(b=>{
    const num = getBusNum(b.name);
    const lon6 = Math.abs(b.x).toFixed(6)+(b.x<0?'W':'E');
    const lat6 = Math.abs(b.y).toFixed(6)+(b.y<0?'S':'N');
    locText += `${num}  ${lon6}  ${lat6}  90  0.80\n`;
  });
  locText += 'BRANCHES\n';
  document.getElementById('locPane').textContent = locText;
  // .idv and branch.idv
  let idvText = '';
  coordsOnly.forEach(b=>{
    const num = getBusNum(b.name);
    const type = b.name.endsWith('_LV')?2:1;
    const kv = type===2?lvKV.toFixed(2):mvKV.toFixed(2);
    idvText += `BAT_BUS_DATA_4,${num},0,1,1,1,1,0.0,1.0,0.0,1.1,0.9,1.1,0.9," "\n`;
    idvText += `BAT_BUS_CHNG_4,${num},0,${type},,,,,,${kv},,,,,,,,'${b.name}'\n\n`;
  });
  // Branches
  const feeders=[]; let idx=0;
  while(idx<parsedLayout.length){
    const f = parsedLayout[idx].feeder;
    const group = parsedLayout.filter(x=>x.feeder===f);
    feeders.push(group.map((_,i)=>1001+idx+i));
    idx += group.length;
  }
  branches = [];
  feeders.forEach(arr=>{
    if(arr.length){ branches.push([201, arr[0]]);
      for(let i=0;i<arr.length-1;i++) branches.push([arr[i], arr[i+1]]);
    }
  });
  let brText = '';
  branches.forEach(([a,b])=>{
    brText += `BAT_BRANCH_DATA_3,${a},${b},'2',1,1,1,0,0,0,0.0,0.0001,0.0,0.0,0.0,0.0,0.0,0.0,1.0,1.0,1.0,1.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0," "\n`;
    brText += `BAT_BRANCH_CHNG_3,${a},${b},'2',,,,,,,1111.0,2222.0,3333.0,,,,,4444.0,,,,,,,,,,,,,,,,,,;\n`;
    brText += `BAT_NEWSEQ,;\n`;
    brText += `BAT_SEQ_BRANCH_DATA_3,${a},${b},'2',,6666.0,7777.0,8888.0,,,,,,;\n\n`;
  });
  document.getElementById('idvPane').textContent = idvText;
  document.getElementById('branchIdvPane').textContent = brText;
}

function getBusNum(name){
  if(name==='POI BUS') return 100;
  if(name==='GSU HV BUS') return 101;
  if(name==='SUB-MV BUS') return 201;
  const d=(name.match(/\d+/)||[''])[0];
  return name.endsWith('_LV')?+d[0]+'0'+d.slice(1):+d;
}

// Downloads
['loc','idv','branchIdv'].forEach(type=>{
  document.getElementById(`download${type==='loc'?'Loc':''+(type==='idv'?'Idv':'BranchIdv')}Btn`).addEventListener('click',()=>{
    const pane = document.getElementById(type==='loc'?'locPane':type==='idv'?'idvPane':'branchIdvPane');
    const txt = pane.textContent;
    if(!txt) return alert('Generate first');
    const ext = type==='loc'?'.loc':type==='idv'?'.idv':'.idv';
    const name = type==='branchIdv'?'branch'+ext:'bus'+ext;
    const blob = new Blob([txt],{type:'text/plain'});
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = name;
    a.click();
    URL.revokeObjectURL(a.href);
  });
});

function fitToContainer(m=40){
  if(!busCoords.length) return;
  const X=[], Y=[];
  busCoords.forEach(p=>{ X.push(p.x-p.padWidth, p.x+p.padWidth); Y.push(p.y-p.padHeight, p.y+p.padHeight); });
  const minX = Math.min(...X), maxX = Math.max(...X);
  const minY = Math.min(...Y), maxY = Math.max(...Y);
  const cW = (maxX-minX)+m*2, cH = (maxY-minY)+m*2;
  const CW = container.clientWidth, CH = container.clientHeight;
  const sX = CW/cW, sY = CH/cH;
  const oX = (CW - cW*sX)/2 - (minX-m)*sX;
  const oY = (CH - cH*sY)/2 - (minY-m)*sY;
  canvas.style.transform = `translate(${oX}px,${oY}px) scale(${sX},${sY})`;
  scale = Math.min(sX,sY);
  document.getElementById('zoomSlider').value = scale;
  panX = oX; panY = oY;
}

window.addEventListener('resize', ()=>fitToContainer());
if('ResizeObserver' in window) new ResizeObserver(()=>fitToContainer()).observe(container);
</script>
</body>
</html>
