<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Solar Farm Collector Designer</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet"/>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <style>
    body { font-family:'Inter',sans-serif; background:#f0f8ff; margin:0; }
    main { padding:20px; max-width:1800px; margin:auto; }
    label { display:block; margin:10px 0 4px; font-weight:600; }
    input, textarea {
      width:300px; padding:8px; margin-bottom:10px;
      border:1px solid #ccc; border-radius:6px;
    }
    button {
      margin:10px 10px 0 0; padding:10px 16px;
      background:#0a66c2; color:#fff; border:none;
      border-radius:6px; cursor:pointer;
    }
    button:hover { background:#004a99; }
    canvas {
      border:1px solid #ccc; margin-top:20px; width:100%;
    }
    #coordPane {
      margin-top:10px; padding:10px;
      background:#fff; border:1px solid #ccc;
      font-family:monospace; white-space:pre;
      max-height:300px; overflow:auto;
    }
  </style>
</head>
<body>
<main>
  <h1>⚡ Solar Farm Collector Designer</h1>

  <label>Total Inverters</label>
  <input type="number" id="total" placeholder="e.g., 40" />

  <label>Default Inverters per Feeder</label>
  <input type="number" id="perFeeder" placeholder="e.g., 8" />

  <label>Custom Feeder Configuration</label>
  <textarea id="customFeeder" placeholder="e.g., 4,4,4,4"></textarea>

  <label>Capacitor Bank (kVAR)</label>
  <input type="number" id="capacitor" placeholder="e.g., 500" />

  <label>Voltage (kV)</label>
  <input type="number" id="voltage" placeholder="e.g., 33" />

  <label>Impedance (Z pu)</label>
  <input type="number" id="impedance" placeholder="e.g., 0.03" step="0.01"/>

  <div>
    <input type="checkbox" id="lvLoad"/>
    <label for="lvLoad">Add Load on LV side</label>
  </div>
  <div>
    <input type="checkbox" id="showLegend" checked/>
    <label for="showLegend">Show Legend</label>
  </div>
  <div>
    <input type="checkbox" id="showCoords"/>
    <label for="showCoords">Show Bus Coordinates</label>
  </div>

  <button onclick="generateCollector()">Generate</button>
  <button onclick="exportSVG()">Export SVG</button>
  <button onclick="exportPDF()">Export PDF</button>
  <button onclick="exportDXF()">Export DXF</button>

  <canvas id="schematicCanvas" width="1800" height="2400"></canvas>
  <div id="coordPane">
    Bus coordinates will appear here when you check “Show Bus Coordinates” and hit Generate.
  </div>
</main>

<script>
let parsedLayout = [], poiOrigin = { x:0, y:0 };

function generateCollector() {
  // Inputs
  const total = parseInt(document.getElementById('total').value);
  if (!total || total <= 0) return alert('Enter total inverters');
  const perFeeder = parseInt(document.getElementById('perFeeder').value);
  const customFeeder = document.getElementById('customFeeder').value.trim();
  const capacitor = parseInt(document.getElementById('capacitor').value);
  const voltage = parseFloat(document.getElementById('voltage').value);
  const impedance = parseFloat(document.getElementById('impedance').value);
  const lvLoad = document.getElementById('lvLoad').checked;

  // Build feederConfig
  let feederConfig = [], remaining = total;
  if (customFeeder) {
    feederConfig = customFeeder.split(',')
      .map(n=>parseInt(n.trim()))
      .filter(n=>!isNaN(n));
    let sum = feederConfig.reduce((a,b)=>a+b,0);
    if (sum>total) {
      let running=0;
      feederConfig = feederConfig.filter((n,i)=>{
        if (running+n<=total) { running+=n; return true; }
        if (running<total)  { feederConfig[i]=total-running; running=total; return true; }
        return false;
      });
    } else if (sum<total) {
      let rem=total-sum;
      while(rem-->0) feederConfig.push(1);
    }
  } else {
    while(remaining>0) {
      const cnt=Math.min(perFeeder||total,remaining);
      feederConfig.push(cnt);
      remaining-=cnt;
    }
  }

  // parsedLayout
  parsedLayout = [];
  let invIndex=1;
  feederConfig.forEach((cnt,i)=>{
    for(let j=0;j<cnt;j++){
      parsedLayout.push({
        feeder:i+1,
        inverter:invIndex++,
        capacitor, voltage, impedance,
        hasLoad: lvLoad
      });
    }
  });

  // Draw & collect coords
  drawVerticalRootLayout(feederConfig);
}

function drawVerticalRootLayout(feederConfig) {
  const canvas=document.getElementById('schematicCanvas'),
        ctx=canvas.getContext('2d');
  ctx.clearRect(0,0,canvas.width,canvas.height);

  // Geometry
  const startX=100,
        poiY=100,
        gsuY=poiY+80,
        mvY=gsuY+80,
        feederSpacing=180,
        verticalSpacing=100,
        branchLength=50;

  // Mid & lengths
  const midX=startX+(feederConfig.length*feederSpacing)/2,
        poiLen=200,
        poiStart=midX-poiLen/2,
        poiEnd=midX+poiLen/2;

  // Origin
  poiOrigin={x:midX,y:poiY};

  // Bus coords storage
  const busCoords = [];

  // Helper
  const drawLine=(x1,y1,x2,y2,clr='#000',w=2)=>{
    ctx.strokeStyle=clr; ctx.lineWidth=w;
    ctx.beginPath(); ctx.moveTo(x1,y1); ctx.lineTo(x2,y2); ctx.stroke();
  };

  // Exports
  window.exportSVG=()=>{ const a=document.createElement('a'); a.download='schematic.svg'; a.href=canvas.toDataURL('image/svg+xml'); a.click(); };
  window.exportPDF=()=>{ const {jsPDF}=window.jspdf, pdf=new jsPDF({orientation:'landscape',unit:'pt',format:[canvas.width,canvas.height]}); pdf.addImage(canvas.toDataURL('image/png'),'PNG',0,0,canvas.width,canvas.height); pdf.save('schematic.pdf'); };
  window.exportDXF=()=>alert('DXF export not implemented');

  // ---------- POI BUS ----------
  drawLine(poiStart,poiY,poiEnd,poiY,'#000',3);
  ctx.fillStyle='#000'; ctx.font='12px Inter'; ctx.fillText('POI BUS',poiStart,poiY-10);
  busCoords.push({name:'POI BUS', x:poiStart - poiOrigin.x + 0.5*poiLen, y: 0});

  // Generator & T-Line
  ctx.beginPath(); ctx.arc(midX,poiY-30,10,0,2*Math.PI); ctx.stroke();
  ctx.fillText('Generator',midX-30,poiY-45);
  drawLine(midX,poiY-20,midX,poiY);
  drawLine(midX,poiY,midX,gsuY);
  ctx.fillText('T-Line',midX+10,(poiY+gsuY)/2);

  // ---------- GSU HV BUS ----------
  drawLine(poiStart,gsuY,poiEnd,gsuY,'#0a66c2',4);
  ctx.fillStyle='#000'; ctx.fillText('GSU HV BUS',poiStart,gsuY-10);
  busCoords.push({name:'GSU HV BUS', x:poiStart - poiOrigin.x + 0.5*poiLen, y: gsuY - poiOrigin.y});

  // Transformer
  const xfmrH=40,
        xfmrTop=(gsuY+mvY)/2 - xfmrH/2;
  drawLine(midX,gsuY,midX,xfmrTop,'#2ecc71',2);
  ctx.fillStyle='#2ecc71'; ctx.fillRect(midX-10,xfmrTop,20,xfmrH);
  drawLine(midX,xfmrTop+xfmrH,midX,mvY,'#2ecc71',2);

  // ---------- SUB-MV BUS ----------
  drawLine(startX,mvY,startX+feederConfig.length*feederSpacing,mvY,'#0a66c2',4);
  ctx.fillStyle='#000'; ctx.fillText('SUB-MV BUS',startX,mvY-10);
  busCoords.push({name:'SUB-MV BUS', x:startX - poiOrigin.x + 0.5*feederConfig.length*feederSpacing, y: mvY - poiOrigin.y});

  // ---------- Feeders ----------
  let invCtr=0, feederX=startX+40;
  feederConfig.forEach((cnt,idx)=>{
    const bottomY=mvY+cnt*verticalSpacing;
    drawLine(feederX,mvY,feederX,bottomY,'#444',2);

    for(let j=0;j<cnt;j++){
      const y=mvY+(j+1)*verticalSpacing,
            invName=`INV${1001+invCtr}`,
            tapX=feederX;

      // MV node
      drawLine(tapX,y,tapX+branchLength,y,'#0a66c2',2);
      ctx.fillStyle='red'; ctx.beginPath(); ctx.arc(tapX,y,4,0,2*Math.PI); ctx.fill();
      ctx.fillStyle='#000'; ctx.font='10px Inter'; ctx.fillText(invName,tapX-55,y-10);
      busCoords.push({name:invName, x:tapX-poiOrigin.x, y: y-poiOrigin.y});

      // Padmount
      ctx.fillStyle='#2ecc71'; ctx.fillRect(tapX+branchLength,y-10,20,20);

      // LV node
      const tX=tapX+branchLength+10,
            lvTop=y+10, lvBot=y+40, lvMid=(lvTop+lvBot)/2;
      drawLine(tX,lvTop,tX,lvBot,'#ff9900',2);
      ctx.fillStyle='blue'; ctx.beginPath(); ctx.arc(tX,lvMid,4,0,2*Math.PI); ctx.fill();
      ctx.fillStyle='#000'; ctx.fillText(`${invName}_LV`,tX+10,lvMid+10);
      busCoords.push({name:`${invName}_LV`, x:tX-poiOrigin.x, y: lvMid-poiOrigin.y});

      // Inverter box
      ctx.fillStyle='#ffcc00'; ctx.fillRect(tapX+branchLength-2,lvBot,24,24);
      ctx.fillStyle='#000'; ctx.fillText(`I${invCtr+1}`,tapX+branchLength-5,lvBot+35);

      // Optional load
      if(parsedLayout[invCtr].hasLoad){
        ctx.fillStyle='#ff4444';
        ctx.beginPath(); ctx.arc(tX+20,lvBot+12,5,0,2*Math.PI); ctx.fill();
      }

      invCtr++;
    }

    // Feeder label
    const base=11+Math.floor(idx/2),
          suf=idx%2?'B':'A',
          flbl=`${base}${suf}`;
    ctx.fillStyle='#000'; ctx.fillText(flbl,feederX-10,bottomY+30);
    feederX+=feederSpacing;
  });

  // ---------- Legend ----------
  if(document.getElementById('showLegend').checked){
    const legendX=1400, legendY=100,
          items=[['Red Dot','MV Bus Point'],['Green Box','Transformer'],['Blue Dot','LV Bus Point'],['Yellow Box','Inverter'],['Red Circle','LV Load']];
    ctx.fillStyle='#000'; ctx.font='14px Inter'; ctx.fillText('Legend',legendX,legendY);
    items.forEach((it,i)=>{
      const y=legendY+20+i*20;
      ctx.fillStyle=it[0].includes('Red')?'red':it[0].includes('Green')?'#2ecc71':it[0].includes('Blue')?'blue':'#ffcc00';
      if(it[0].includes('Dot')){
        ctx.beginPath(); ctx.arc(legendX+10,y-4,5,0,2*Math.PI); ctx.fill();
      } else {
        ctx.fillRect(legendX+3,y-10,14,14);
      }
      ctx.fillStyle='#000'; ctx.fillText(it[1],legendX+25,y);
    });
  }

  // ---------- Show Coordinates ----------
  const pane=document.getElementById('coordPane');
  if(document.getElementById('showCoords').checked){
    pane.textContent = busCoords
      .map(b => `${b.name.padEnd(12)} (${b.x.toFixed(0).padStart(4)}, ${b.y.toFixed(0).padStart(4)})`)
      .join('\n');
  } else {
    pane.textContent = 'Bus coordinates will appear here when you check “Show Bus Coordinates” and hit Generate.';
  }
}
</script>
</body>
</html>
