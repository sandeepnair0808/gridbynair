<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Solar Farm Collector Designer</title>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet"/>
  <style>
    body { font-family:'Inter',sans-serif; background:#f0f8ff; margin:0 }
    main { padding:20px; max-width:1800px; margin:auto }
    label { display:block; margin:10px 0 4px; font-weight:600 }
    input, textarea {
      width:300px; padding:8px; margin-bottom:10px;
      border:1px solid #ccc; border-radius:6px;
    }
    button {
      margin:10px 10px 0 0; padding:10px 16px;
      background:#0a66c2; color:#fff; border:none;
      border-radius:6px; cursor:pointer;
    }
    button:hover { background:#004a99 }
    #canvasContainer {
      width:100%; height:60vh; min-height:400px;
      border:1px solid #ccc; overflow:hidden;
      position:relative; cursor:grab;
    }
    #canvasContainer.grabbing { cursor:grabbing }
    canvas { transform-origin:0 0; display:block }
    #coordContainer { display:grid; grid-template-columns:1fr 1fr; gap:10px; margin-top:10px }
    .coordPane {
      background:#fff; border:1px solid #ccc;
      padding:10px; font-family:monospace; white-space:pre;
      max-height:200px; overflow:auto;
    }
  </style>
</head>
<body>
<main>
  <h1>âš¡ Solar Farm Collector Designer</h1>
  <label>Total Inverters</label>
  <input type="number" id="total" placeholder="e.g., 40">
  <label>Default Inverters per Feeder</label>
  <input type="number" id="perFeeder" placeholder="e.g., 8">
  <label>Custom Feeder Configuration</label>
  <textarea id="customFeeder" placeholder="e.g., 4,4,4,4"></textarea>
  <label>Capacitor Bank (kVAR)</label>
  <input type="number" id="capacitor" placeholder="e.g., 500">
  <label>MV Voltage (kV)</label>
  <input type="number" id="mvVoltage" value="34.5" step="0.1">
  <label>LV Voltage (kV)</label>
  <input type="number" id="lvVoltage" value="0.66" step="0.01">
  <label>Impedance (Z pu)</label>
  <input type="number" id="impedance" placeholder="e.g., 0.03" step="0.01"/>
  <div><input type="checkbox" id="lvLoad"><label for="lvLoad">Add Load on LV side</label></div>
  <div><input type="checkbox" id="showLegend" checked><label for="showLegend">Show Legend</label></div>
  <div><input type="checkbox" id="showCoords"><label for="showCoords">Show Bus Coordinates</label></div>
  <button id="genBtn">Generate</button>
  <button id="downloadLocBtn">Download .loc</button>
  <button id="downloadBusIdvBtn">bus.idv</button>
  <button id="downloadCableIdvBtn">cable.idv</button>

  <div id="canvasContainer">
    <canvas id="schematicCanvas" width="1800" height="2400"></canvas>
  </div>

  <div id="coordContainer">
    <div id="leftPane"  class="coordPane">Bus coordinates will appear here.</div>
    <div id="locPane"   class="coordPane">.loc output will appear here.</div>
    <div id="idvPane"   class="coordPane">bus.idv output will appear here.</div>
    <div id="branchPane" class="coordPane">cable.idv output will appear here.</div>
  </div>
</main>
<script>
let scale = 1, translateX = 0, translateY = 0;
let isPanning = false, startPan = {x:0, y:0};
let lastFeederConfig = [];
const canvas = document.getElementById('schematicCanvas');
const ctx = canvas.getContext('2d');
const canvasContainer = document.getElementById('canvasContainer');

touchEvents();

function touchEvents(){
  canvasContainer.addEventListener('mousedown', e => {
    isPanning = true;
    startPan = { x: e.clientX - translateX, y: e.clientY - translateY };
    canvasContainer.classList.add('grabbing');
  });
  document.addEventListener('mousemove', e => {
    if (!isPanning) return;
    translateX = e.clientX - startPan.x;
    translateY = e.clientY - startPan.y;
    drawLayout(lastFeederConfig);
  });
  document.addEventListener('mouseup', () => {
    isPanning = false;
    canvasContainer.classList.remove('grabbing');
  });
  canvasContainer.addEventListener('wheel', e => {
    e.preventDefault();
    const mouseX = (e.clientX - translateX) / scale;
    const mouseY = (e.clientY - translateY) / scale;
    const delta = -e.deltaY * 0.001;
    const newScale = scale * (1 + delta);
    translateX -= mouseX * (newScale - scale);
    translateY -= mouseY * (newScale - scale);
    scale = newScale;
    drawLayout(lastFeederConfig);
  }, { passive: false });
  let touchState = {};
  canvasContainer.addEventListener('touchstart', e => {
    if (e.touches.length === 2) {
      e.preventDefault();
      const [t1, t2] = e.touches;
      touchState.initialDist = Math.hypot(t2.clientX - t1.clientX, t2.clientY - t1.clientY);
      touchState.initialScale = scale;
      touchState.center = {
        x: (t1.clientX + t2.clientX)/2 - translateX,
        y: (t1.clientY + t2.clientY)/2 - translateY
      };
    } else if (e.touches.length === 1) {
      isPanning = true;
      startPan = { x: e.touches[0].clientX - translateX, y: e.touches[0].clientY - translateY };
    }
  }, { passive: false });
  canvasContainer.addEventListener('touchmove', e => {
    if (e.touches.length === 2) {
      e.preventDefault();
      const [t1, t2] = e.touches;
      const dist = Math.hypot(t2.clientX - t1.clientX, t2.clientY - t1.clientY);
      const newScale = touchState.initialScale * (dist / touchState.initialDist);
      const centerX = (t1.clientX + t2.clientX)/2;
      const centerY = (t1.clientY + t2.clientY)/2;
      translateX = centerX - touchState.center.x * newScale;
      translateY = centerY - touchState.center.y * newScale;
      scale = newScale;
      drawLayout(lastFeederConfig);
    } else if (e.touches.length === 1 && isPanning) {
      e.preventDefault();
      translateX = e.touches[0].clientX - startPan.x;
      translateY = e.touches[0].clientY - startPan.y;
      drawLayout(lastFeederConfig);
    }
  }, { passive: false });
  canvasContainer.addEventListener('touchend', () => { if (event.touches.length < 2) isPanning = false; });
}

const genBtn = document.getElementById('genBtn');
const downloadLocBtn = document.getElementById('downloadLocBtn');
const downloadBusIdvBtn = document.getElementById('downloadBusIdvBtn');
const downloadCableIdvBtn = document.getElementById('downloadCableIdvBtn');
const leftPane = document.getElementById('leftPane');
const locPane = document.getElementById('locPane');
const idvPane = document.getElementById('idvPane');
const branchPane = document.getElementById('branchPane');
let busCoords = [], branches = [];
let mvKV = 34.5, lvKV = 0.66;

genBtn.addEventListener('click', generateCollector);

defaults and helper functions remain unchanged

function generateCollector() {
  const total = +document.getElementById('total').value;
  if (!total) return alert('Enter total inverters');
  const perFeeder = +document.getElementById('perFeeder').value;
  const custom = document.getElementById('customFeeder').value.trim();
  mvKV = +document.getElementById('mvVoltage').value;
  lvKV = +document.getElementById('lvVoltage').value;
  let feederConfig = [], rem = total;
  if (custom) {
    feederConfig = custom.split(',').map(n=>+n).filter(n=>n>0);
    let sum = feederConfig.reduce((a,b)=>a+b,0);
    if (sum < total) while(sum++ < total) feederConfig.push(1);
    else if (sum > total) {
      let run = 0;
      feederConfig = feederConfig.filter(n => {
        if (run + n <= total) { run += n; return true; }
        if (run < total) { feederConfig.push(total-run); run = total; return true; }
        return false;
      });
    }
  } else {
    while (rem > 0) {
      const cnt = Math.min(perFeeder||total, rem);
      feederConfig.push(cnt);
      rem -= cnt;
    }
  }
  lastFeederConfig = feederConfig;
  drawLayout(feederConfig);
  updatePanes();
}

function drawLayout(feederConfig) {
  // clear
  ctx.save(); ctx.setTransform(1,0,0,1,0,0); ctx.clearRect(0,0,canvas.width,canvas.height); ctx.restore();
  // pan & zoom
  ctx.save(); ctx.setTransform(scale,0,0,scale,translateX,translateY);

  busCoords = [];
  const baseY = 100, sx = 180, sy = 100;
  const startX = 900 - ((feederConfig.length-1)/2) * sx;
  const busY = baseY + 160;

  // connections: POI -> GSU HV -> transformer -> subMV
  ctx.strokeStyle = '#000'; ctx.lineWidth = 2;
  ctx.beginPath(); ctx.moveTo(900, baseY); ctx.lineTo(900, baseY+80); ctx.lineTo(900, baseY+100); ctx.stroke();
  ctx.beginPath(); ctx.moveTo(900, baseY+140); ctx.lineTo(900, busY); ctx.stroke();

  // subMV horizontal bus
  const busStartX = startX - sx/2;
  const busEndX = startX + (feederConfig.length-1) * sx + sx/2;
  ctx.strokeStyle = '#2c7a7b'; ctx.lineWidth = 8;
  ctx.beginPath(); ctx.moveTo(busStartX, busY); ctx.lineTo(busEndX, busY); ctx.stroke();

  // POI & GSU HV markers
  ctx.fillStyle = '#0a66c2';
  [['POI BUS',900,baseY], ['GSU HV BUS',900,baseY+80]].forEach(([name,x,y]) => {
    ctx.beginPath(); ctx.arc(x,y,10,0,2*Math.PI); ctx.fill();
    ctx.fillStyle = '#000'; ctx.fillText(name, x+15, y+5);
  });

  // transformer
  ctx.fillStyle = '#2ecc71'; ctx.fillRect(890, baseY+100, 20, 40);
  ctx.fillStyle = '#000'; ctx.fillText('GSU XFMR', 920, baseY+125);

  // SUB-MV label (no dot)
  ctx.fillStyle = '#000'; ctx.fillText('SUB-MV BUS', 915, busY+5);

  // feeders
  let invCounter = 0;
  feederConfig.forEach((nInv,f) => {
    const colX = startX + f * sx;
    let prevY = busY;
    for (let j = 0; j < nInv; j++) {
      const mvY = baseY + 260 + j * sy;
      const invName = `INV${1001 + invCounter}`;
      const lvY = mvY + 30, padY = lvY + 30;
      // lines
      ctx.strokeStyle = '#aaa'; ctx.lineWidth = 3;
      ctx.beginPath(); ctx.moveTo(colX, prevY); ctx.lineTo(colX, mvY); ctx.stroke();
      ctx.strokeStyle = '#00c'; ctx.lineWidth = 2;
      ctx.beginPath(); ctx.moveTo(colX, mvY); ctx.lineTo(colX, lvY); ctx.stroke();
      ctx.strokeStyle = '#0a66c2'; ctx.lineWidth = 2;
      ctx.beginPath(); ctx.moveTo(colX, lvY); ctx.lineTo(colX, padY); ctx.stroke();

      // MV short bus
      ctx.fillStyle = 'red'; ctx.fillRect(colX - 10, mvY - 2, 20, 4);
      ctx.fillStyle = '#000'; ctx.fillText(invName, colX + 15, mvY + 5);
      busCoords.push({ name: invName, x: colX, y: mvY });

      // LV bus dot
      ctx.fillStyle = 'blue'; ctx.beginPath(); ctx.arc(colX, lvY, 6, 0, 2 * Math.PI); ctx.fill();
      ctx.fillStyle = '#000'; ctx.fillText(`${invName}_LV`, colX + 12, lvY + 5);
      busCoords.push({ name: `${invName}_LV`, x: colX, y: lvY });

      // padmount
      ctx.fillStyle = '#2ecc71'; ctx.fillRect(colX - 8, padY - 8, 16, 16);
      ctx.fillStyle = '#000'; ctx.fillText('PAD', colX + 12, padY + 5);
      prevY = padY;
      invCounter++;
    }
  });

  ctx.restore();
}

function updatePanes() {
  const coordsOnly = busCoords;
  leftPane.textContent = coordsOnly.map(b => `${b.name.padEnd(12)} (${Math.round(b.x)}, ${Math.round(b.y)})`).join('\n');
  // .loc output
  let loc = 'GEOPHYSICAL\n';
  coordsOnly.forEach(b => {
    const num = getBusNum(b.name);
    const lon6 = Math.abs(b.x).toFixed(6) + (b.x < 0 ? 'W' : 'E');
    const lat6 = Math.abs(b.y).toFixed(6) + (b.y < 0 ? 'S' : 'N');
    loc += `${num}  ${lon6}  ${lat6}  90  0.80\n`;
  });
  loc += 'BRANCHES\n';
  locPane.textContent = loc;
  // .idv output
  let idv = '';
  coordsOnly.forEach(b => {
    const num = getBusNum(b.name);
    const type = b.name.endsWith('_LV') ? 2 : 1;
    const kv = (type === 2 ? lvKV : mvKV).toFixed(2);
    idv += `BAT_BUS_DATA_4,${num},0,1,1,1,1,0.0,1.0,0.0,1.1,0.9,1.1,0.9,\" \"\n`;
    idv += `BAT_BUS_CHNG_4,${num},0,${type},,,,,,${kv},,,,,,,,'${b.name}'\n\n`;
  });
  idvPane.textContent = idv;
  // branches output
  const feeders = [];
  let idx = 0;
  lastFeederConfig.forEach(count => {
    const list = [];
    for (let i = 0; i < count; i++) {
      list.push(getBusNum(`INV${1001 + idx}`));
      idx++;
    }
    feeders.push(list);
  });
  let br = '';
  feeders.forEach(list => {
    if (list.length) {
      // SUB-MV to first
      br += `BAT_BRANCH_DATA_3,201,${list[0]},'2',1,1,1,0,0,0,0.0,0.0001,0.0,0.0,0.0,0.0,0.0,0.0,1.0,1.0,1.0,1.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,\" \"\n`;
      br += `BAT_BRANCH_CHNG_3,201,${list[0]},'2',,,,,,,1111.0,2222.0,3333.0,,,,,4444.0,,,,,,,,,,,,,,,,,,;\n`;
      br += `BAT_NEWSEQ,;\n`;
      br += `BAT_SEQ_BRANCH_DATA_3,201,${list[0]},'2',,6666.0,7777.0,8888.0,,,,,,;\n\n`;
      for (let i = 0; i < list.length - 1; i++) {
        const a = list[i], b = list[i+1];
        br += `BAT_BRANCH_DATA_3,${a},${b},'2',1,1,1,0,0,0,0.0,0.0001,0.0,0.0,0.0,0.0,0.0,0.0,1.0,1.0,1.0,1.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,\" \"\n`;
        br += `BAT_BRANCH_CHNG_3,${a},${b},'2',,,,,,,1111.0,2222.0,3333.0,,,,,4444.0,,,,,,,,,,,,,,,,,,;\n`;
        br += `BAT_NEWSEQ,;\n`;
        br += `BAT_SEQ_BRANCH_DATA_3,${a},${b},'2',,6666.0,7777.0,8888.0,,,,,,;\n\n`;
      }
    }
  });
  branchPane.textContent = br;
}

function getBusNum(name) {
  if (name === 'POI BUS') return 100;
  if (name === 'GSU HV BUS') return 101;
  if (name === 'SUB-MV BUS') return 201;
  const m = name.match(/INV(\d+)/);
  if (m) {
    const n = parseInt(m[1], 10);
    return name.endsWith('_LV') ? n * 10 : n;
  }
  return 0;
}

// Download handlers (unchanged from prior implementation)
</script>
</body>
</html>
